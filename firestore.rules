rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    //----------------------------------------------------------------
    // Helper Functions
    //----------------------------------------------------------------

    // Is the user an administrator?
    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Can the user write content? (Not banned or muted)
    function canWrite(uid) {
      let user = get(/databases/$(database)/documents/users/$(uid));
      return user.exists()
        && !(user.data.get('isBanned', false))
        && !(user.data.get('isMuted', false));
    }
    
    // Is the user the author of a specific thread?
    function isThreadAuthor(threadId) {
        return get(/databases/$(database)/documents/threads/$(threadId)).data.authorId == request.auth.uid;
    }

    // Is the thread locked?
    function isThreadLocked(threadId) {
      return get(/databases/$(database)/documents/threads/$(threadId)).data.isLocked == true;
    }

    //----------------------------------------------------------------
    // USER PROFILES
    //----------------------------------------------------------------
    match /users/{userId} {
      allow read: if true;

      // Users can create their own profile.
      allow create: if request.auth.uid == userId;

      // Users can update their own profile, admins can update any profile.
      allow update: if request.auth.uid == userId || isAdmin();
    }

    //----------------------------------------------------------------
    // POSTS (Activity Feed)
    //----------------------------------------------------------------
    match /posts/{postId} {
      // Allow reading posts, visibility is checked client-side.
      allow read: if true;

      // Allow creating posts if authenticated and not banned/muted.
      allow create: if canWrite(request.auth.uid)
        && request.resource.data.authorId == request.auth.uid;

      // Allow authors or admins to delete.
      allow delete: if (isThreadAuthor(postId) || isAdmin());

      // Allow authors/admins to update most fields, but any user to update counts.
      allow update: if request.auth != null && (
        (isThreadAuthor(postId) || isAdmin()) ||
        (
          request.resource.data.diff(resource.data).affectedKeys()
            .hasAny(['likesCount', 'commentsCount', 'sharesCount']) &&
          (request.resource.data.likesCount == resource.data.likesCount + 1 ||
           request.resource.data.likesCount == resource.data.likesCount - 1 ||
           request.resource.data.commentsCount == resource.data.commentsCount + 1 ||
           request.resource.data.sharesCount == resource unui.data.sharesCount + 1)
        )
      );

      // Likes subcollection
      match /likes/{userId} {
        allow read: if true;
        allow write: if request.auth.uid == userId;
      }

      // Comments subcollection
      match /comments/{commentId} {
        allow read: if true;
        allow create: if canWrite(request.auth.uid)
          && request.resource.data.authorId == request.auth.uid;
        allow delete: if get(/databases/$(database)/documents/posts/$(postId)/comments/$(commentId)).data.authorId == request.auth.uid || isAdmin();
      }
    }

    //----------------------------------------------------------------
    // GROUPS & CHAT
    //----------------------------------------------------------------
    match /groups/{groupId} {
      allow read: if true;

      allow create: if canWrite(request.auth.uid);

      allow update: if get(/databases/$(database)/documents/groups/$(groupId)).data.members[request.auth.uid] in ['owner', 'admin'] || isAdmin();

      // Messages subcollection
      match /messages/{messageId} {
        allow read: if get(/databases/$(database)/documents/groups/$(groupId)).data.members[request.auth.uid] != null || isAdmin();
        allow create: if canWrite(request.auth.uid)
          && get(/databases/$(database)/documents/groups/$(groupId)).data.members[request.auth.uid] != null;
      }

      // Typing indicators subcollection
      match /typing/{userId} {
        allow read, write: if request.auth.uid == userId;
      }
    }

    //----------------------------------------------------------------
    // FORUMS
    //----------------------------------------------------------------
    match /forums/{forumId} {
      allow read: if true;
      allow create: if canWrite(request.auth.uid);
    }
    
    //----------------------------------------------------------------
    // CATEGORIES
    //----------------------------------------------------------------
    match /categories/{categoryId} {
        allow read: if true;
        allow create: if canWrite(request.auth.uid);
    }

    //----------------------------------------------------------------
    // THREADS (Discussions)
    //----------------------------------------------------------------
    match /threads/{threadId} {
      allow read: if true;

      allow create: if canWrite(request.auth.uid)
        && request.resource.data.authorId == request.auth.uid
        && exists(/databases/$(database)/documents/forums/$(request.resource.data.forumId));

      allow delete: if isThreadAuthor(threadId) || isAdmin();
      
      allow update: if request.auth != null && (
        // Case 1: Author or admin can update core fields (e.g., lock, pin, body, title)
        (isThreadAuthor(threadId) || isAdmin())
        ||
        // Case 2: Any authenticated user can increment/decrement replyCount if the thread isn't locked.
        (
          !isThreadLocked(threadId) &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['replyCount', 'latestReplyAt']) &&
          request.resource.data.replyCount == resource.data.replyCount + 1
        )
      );

      // Replies subcollection
      match /replies/{replyId} {
        allow read: if true;
        allow create: if canWrite(request.auth.uid) && !isThreadLocked(threadId);
        allow update, delete: if get(/databases/$(database)/documents/threads/$(threadId)/replies/$(replyId)).data.authorId == request.auth.uid || isAdmin();
      }

      // Chat Messages for a thread (if used)
      match /chatMessages/{messageId} {
          allow read: if true;
          allow create: if canWrite(request.auth.uid) && !isThreadLocked(threadId);
      }
    }
  }
}
