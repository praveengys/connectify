rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isOwner(uid) {
      return request.auth.uid == uid;
    }

    function isAdmin() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function canWrite(uid) {
      let userDoc = get(/databases/$(database)/documents/users/$(uid));
      // Use .get() to provide default values for potentially missing fields
      return userDoc.exists() &&
             userDoc.data.get('isBanned', false) == false &&
             userDoc.data.get('isMuted', false) == false;
    }

    function isThreadLocked(threadId) {
        let threadDoc = get(/databases/$(database)/documents/threads/$(threadId));
        return threadDoc.exists() && threadDoc.data.get('isLocked', false) == true;
    }

    // User Profiles
    match /users/{userId} {
      allow read: if true;
      allow create: if isOwner(userId) && request.resource.data.role == 'member';
      allow update: if (isOwner(userId) || isAdmin()) && !('role' in request.resource.data.diff(resource.data));
    }

    // Admin-only role updates
    match /users/{userId} {
      allow update: if isAdmin() && 'role' in request.resource.data.diff(resource.data);
    }
    
    // Categories for Forums
    match /categories/{categoryId} {
        allow read: if true;
        allow create: if request.auth != null && (isAdmin() || canWrite(request.auth.uid));
        allow update: if isAdmin();
    }
    
    // Forums
    match /forums/{forumId} {
        allow read: if true;
        allow create: if request.auth != null && canWrite(request.auth.uid);
        allow update, delete: if isAdmin();
    }

    // Threads
    match /threads/{threadId} {
        allow read: if true;
        allow create: if request.auth != null && canWrite(request.auth.uid) && request.resource.data.authorId == request.auth.uid;
        
        allow update: if request.auth != null && canWrite(request.auth.uid) &&
            // Case 1: An admin or the owner is editing the thread (excluding replyCount)
            ( (isOwner(resource.data.authorId) || isAdmin()) && !('replyCount' in request.resource.data.diff(resource.data)) ) ||
            // Case 2: A user is posting a reply, only allow incrementing replyCount by 1
            ( request.resource.data.diff(resource.data).affectedKeys().hasOnly(['replyCount', 'updatedAt', 'latestReplyAt']) &&
              request.resource.data.replyCount == resource.data.replyCount + 1 &&
              !isThreadLocked(threadId) );

        allow delete: if isOwner(resource.data.authorId) || isAdmin();
    }

    // Replies to Threads
    match /threads/{threadId}/replies/{replyId} {
        allow read: if true;
        allow create: if request.auth != null && canWrite(request.auth.uid) && !isThreadLocked(threadId);
        allow update: if isOwner(resource.data.authorId) || isAdmin();
        allow delete: if isOwner(resource.data.authorId) || isAdmin();
    }
    
    // Chat Groups
    match /groups/{groupId} {
        allow read: if true;
        allow create: if request.auth != null && canWrite(request.auth.uid);
        allow update: if request.auth != null && (isAdmin() || request.auth.uid in resource.data.members);
        allow delete: if isAdmin();
    }
    
    // Chat Messages within Groups
    match /groups/{groupId}/messages/{messageId} {
        allow read, write: if request.auth != null && request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.members;
    }

    // Typing indicators in groups
    match /groups/{groupId}/typing/{userId} {
      allow read: if request.auth != null && request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.members;
      allow write: if isOwner(userId);
    }

    // Activity Feed Posts
    match /posts/{postId} {
        allow read: if true;
        allow create: if request.auth != null && canWrite(request.auth.uid) && request.resource.data.authorId == request.auth.uid;
        allow update: if request.auth != null && canWrite(request.auth.uid) &&
            // Case 1: Owner or Admin is editing
            (isOwner(resource.data.authorId) || isAdmin()) ||
            // Case 2: Any user is liking/commenting/sharing (only affects counts)
            ( request.resource.data.diff(resource.data).affectedKeys().hasAny(['likesCount', 'commentsCount', 'sharesCount']) );
        allow delete: if isOwner(resource.data.authorId) || isAdmin();
    }
    
    // Comments on Posts
    match /posts/{postId}/comments/{commentId} {
        allow read: if true;
        allow create: if request.auth != null && canWrite(request.auth.uid) && exists(/databases/$(database)/documents/posts/$(postId));
        allow update, delete: if isOwner(resource.data.authorId) || isAdmin();
    }
    
    // Likes on Posts
    match /posts/{postId}/likes/{userId} {
        allow read: if true;
        allow write: if isOwner(userId) && canWrite(userId) && exists(/databases/$(database)/documents/posts/$(postId));
    }
  }
}
