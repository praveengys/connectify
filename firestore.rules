
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Global helper functions
    function signedIn() {
      return request.auth != null;
    }
    
    function uid() {
      return request.auth.uid;
    }
    
    function isOwner(userId) {
      return signedIn() && uid() == userId;
    }
    
    // Safely get user data, returns a default non-admin role if user doc doesn't exist.
    function getUserData(userId) {
      let userDoc = get(/databases/$(database)/documents/users/$(userId));
      if (exists(/databases/$(database)/documents/users/$(userId))) {
        return userDoc.data;
      } else {
        // Return a default object that won't have admin/moderator roles
        return {"role": "member"};
      }
    }
    
    function isAdmin() {
      return signedIn() && getUserData(uid()).role == 'admin';
    }
    
    function isModerator() {
      return signedIn() && (getUserData(uid()).role == 'admin' || getUserData(uid()).role == 'moderator');
    }

    // USER PROFILES
    match /users/{userId} {
      allow read: if signedIn() && (isOwner(userId) || getUserData(userId).profileVisibility == 'public');
      allow create: if isOwner(userId);
      // Prevent users from changing their own role. Only admins can change roles.
      // The role field is handled by a separate admin-only function.
      allow update: if isOwner(userId) && !("role" in request.resource.data.keys());

      // NOTIFICATIONS SUBCOLLECTION
      match /notifications/{notificationId} {
        allow read, update, delete: if isOwner(userId); // Only the user can manage their own notifications
        allow create: if signedIn(); // Allow server-side processes to create notifications
      }
    }
    
    // POSTS (SOCIAL FEED)
    match /posts/{postId} {
      allow read: if signedIn();
      
      allow create: if signedIn()
        && request.resource.data.authorId == uid()
        && request.resource.data.content is string
        && request.resource.data.createdAt is timestamp;
        
      allow update: if isOwner(resource.data.authorId) || isModerator();
      allow delete: if isOwner(resource.data.authorId) || isAdmin();
      
      // LIKES SUBCOLLECTION
      match /likes/{userId} {
         allow read: if signedIn();
         // A user can only like/unlike for themselves.
         allow create, delete: if isOwner(userId);
      }
      
      // COMMENTS SUBCOLLECTION
      match /comments/{commentId} {
        allow read: if signedIn();
        allow create: if signedIn();
        allow update, delete: if signedIn() && (isOwner(resource.data.authorId) || isModerator());
      }
    }
    
    // GROUPS (CHAT)
    match /groups/{groupId} {
      allow read: if signedIn();
      allow create: if signedIn();
      allow update: if signedIn() && (
        // Check if user is an admin of the group
        getUserData(uid()).role == 'admin' || 
        get(/databases/$(database)/documents/groups/$(groupId)).data.memberRoles[uid()] == 'admin' ||
        get(/databases/$(database)/documents/groups/$(groupId)).data.memberRoles[uid()] == 'owner'
      );
      allow delete: if signedIn() && (
        isAdmin() || get(/databases/$(database)/documents/groups/$(groupId)).data.memberRoles[uid()] == 'owner'
      );
      
      match /messages/{messageId} {
        allow read, create: if signedIn() && request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.members;
        allow update, delete: if signedIn() && (isModerator() || isOwner(resource.data.senderId));
      }
      
      match /typing/{userId} {
        allow read, write: if isOwner(userId) && request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.members;
      }
    }
    
    // FORUMS & DISCUSSIONS
    match /forums/{forumId} {
      allow read, create: if signedIn();
      allow update, delete: if isModerator();
    }
    
    match /categories/{categoryId} {
      allow read, create: if signedIn();
      allow update, delete: if isModerator();
    }
    
    match /threads/{threadId} {
      allow read: if signedIn();
      allow create: if signedIn() && request.resource.data.authorId == uid();
      allow update: if signedIn() && (isOwner(resource.data.authorId) || isModerator());
      allow delete: if signedIn() && (isOwner(resource.data.authorId) || isAdmin());
      
      match /replies/{replyId} {
        allow read, create: if signedIn();
        allow update, delete: if signedIn() && (isOwner(resource.data.authorId) || isModerator());
      }
      
      match /chatMessages/{messageId} {
         allow read, create: if signedIn();
      }
    }
    
    // DEMO BOOKING
    match /demoSlots/{slotId} {
        allow read: if signedIn();
        allow create, update, delete: if isAdmin();
    }
    
    match /demoBookings/{bookingId} {
        allow read: if signedIn(); // Users can read their bookings, admins can read all
        allow create: if signedIn();
        allow update, delete: if isAdmin();
    }
  }
}
