
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is authenticated, not banned, and not muted.
    function canWrite() {
      let user = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
      return request.auth != null && user.isBanned != true && user.isMuted != true;
    }
    
    // Helper function to check if a user is an admin.
    function isAdmin() {
      let user = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
      return user.role == 'admin';
    }

    match /users/{userId} {
      allow read: if true;
      allow create: if request.auth.uid == userId;
      allow update: if request.auth.uid == userId || isAdmin();
      allow delete: if isAdmin();
    }

    match /posts/{postId} {
      allow read: if true;

      allow create: if canWrite()
        && request.resource.data.authorId == request.auth.uid
        && request.resource.data.createdAt == request.time
        && request.resource.data.updatedAt == request.time
        && request.resource.data.likesCount == 0
        && request.resource.data.commentsCount == 0
        && request.resource.data.sharesCount == 0
        && request.resource.data.repostsCount == 0
        && request.resource.data.visibility in ['public', 'group-only']
        && (
          (
            request.resource.data.isRepost == false
            && (
              !('media' in request.resource.data) ||
              (
                'media' in request.resource.data &&
                request.resource.data.media is list &&
                request.resource.data.media.size() <= 4 &&
                (request.resource.data.media.size() == 0 || request.resource.data.media[0] is string)
              )
            )
          ) || (
            request.resource.data.isRepost == true
            && get(/databases/$(database)/documents/posts/$(request.resource.data.originalPostId)).data.authorId != request.auth.uid // Cannot repost own content
            && request.resource.data.originalPostId is string
            && request.resource.data.originalAuthor is map
            && request.resource.data.originalPostCreatedAt is timestamp
          )
        );

        allow update: if canWrite() && (
            // Case 1: The owner of the post is editing it.
            (resource.data.authorId == request.auth.uid &&
             request.resource.data.authorId == resource.data.authorId &&
             request.resource.data.createdAt == resource.data.createdAt)
            ||
            // Case 2: Any user is liking, commenting, sharing, or reposting.
            (request.resource.data.diff(resource.data).affectedKeys()
                .hasOnly(['likesCount', 'commentsCount', 'sharesCount', 'repostsCount']))
        );

      allow delete: if resource.data.authorId == request.auth.uid || isAdmin();

      match /likes/{userId} {
        allow read: if true;
        allow create: if request.auth.uid == userId && canWrite();
        allow delete: if request.auth.uid == userId;
      }
      
      match /comments/{commentId} {
        allow read: if true;
        allow create: if canWrite()
          && request.resource.data.authorId == request.auth.uid
          && request.resource.data.postId == postId;
        allow update: if canWrite() && resource.data.authorId == request.auth.uid;
        allow delete: if resource.data.authorId == request.auth.uid || isAdmin();
      }
    }
    
    match /groups/{groupId} {
        allow read: if resource.data.type == 'public' || request.auth.uid in resource.data.members;
        allow create: if canWrite();
        allow update: if canWrite() && (request.auth.uid == resource.data.createdBy || request.auth.uid in resource.data.members);
        allow delete: if request.auth.uid == resource.data.createdBy || isAdmin();

        match /messages/{messageId} {
            allow read: if request.auth.uid in resource.data.members;
            allow create: if canWrite() && request.auth.uid in resource.data.members;
            allow update: if canWrite() && request.auth.uid == resource.data.senderId;
            allow delete: if canWrite() && (request.auth.uid == resource.data.senderId || request.auth.uid == get(/databases/$(database)/documents/groups/$(groupId)).data.createdBy || isAdmin());
        }

        match /typing/{userId} {
            allow read, write: if request.auth.uid == userId;
        }
    }
    
    match /categories/{categoryId} {
        allow read: if true;
        allow create: if canWrite() || isAdmin();
        allow update, delete: if isAdmin();
    }
    
    match /forums/{forumId} {
        allow read: if true;
        allow create: if canWrite() || isAdmin();
        allow update, delete: if isAdmin();
    }

    match /threads/{threadId} {
        allow read: if true;
        allow create: if canWrite();
        allow update: if (canWrite() && resource.data.authorId == request.auth.uid) || isAdmin();
        allow delete: if isAdmin();

        match /replies/{replyId} {
            allow read: if true;
            allow create: if canWrite();
            allow update: if (canWrite() && resource.data.authorId == request.auth.uid) || isAdmin();
            allow delete: if isAdmin();
        }
    }
  }
}
