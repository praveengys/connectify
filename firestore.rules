
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAdmin() {
      return request.auth != null && request.auth.token.role == 'admin';
    }

    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    function canWrite() {
      return request.auth != null && request.auth.token.isMuted != true;
    }

    // User Profiles
    match /users/{userId} {
      allow read: if true;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }
    
    // Groups & Messages
    match /groups/{groupId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update: if isAdmin() || (request.auth.uid in resource.data.members && resource.data.members[request.auth.uid] in ['owner', 'admin']);
      allow delete: if isAdmin();
      
      match /messages/{messageId} {
        allow read, list: if request.auth.uid in resource.data.members;
        allow create: if request.auth.uid in resource.data.members && canWrite();
      }
      
      match /typing/{userId} {
        allow read: if request.auth.uid in resource.data.members;
        allow write: if isOwner(userId);
      }
    }

    // Forum
    match /forums/{forumId} {
        allow read: if true;
        allow create: if canWrite();
        allow update, delete: if isAdmin();
    }
    
    match /categories/{categoryId} {
        allow read: if true;
        allow create, update, delete: if isAdmin();
    }
    
    match /threads/{threadId} {
      allow read: if true;
      allow create: if canWrite();
      allow update: if isOwner(resource.data.authorId) || isAdmin();
      allow delete: if isAdmin();
      
      match /replies/{replyId} {
        allow read, list: if true;
        allow create: if canWrite();
        allow update: if isOwner(resource.data.authorId) || isAdmin();
        allow delete: if isAdmin();
      }
      
       match /chatMessages/{messageId} {
        allow read, list: if true;
        allow create: if canWrite();
        allow update: if isOwner(resource.data.senderId) || isAdmin();
        allow delete: if isAdmin();
      }
    }
    
    // Social Feed
    match /posts/{postId} {
        allow read: if true;
        allow create: if canWrite();
        allow update: if isOwner(resource.data.authorId) || isAdmin();
        allow delete: if isAdmin();
        
        match /likes/{userId} {
            allow read: if true;
            allow write: if isOwner(userId) && canWrite();
        }
        
        match /comments/{commentId} {
            allow read, list: if true;
            allow create: if canWrite();
            allow update: if isOwner(resource.data.authorId) || isAdmin();
            allow delete: if isAdmin();
        }
    }

    /* Demo Scheduling */
    match /demoBookings/{bookingId} {
      // Allow anyone to check for conflicting bookings.
      allow list: if true;
      
      // Only an admin or the booking owner can read the actual document data.
      allow get: if isAdmin() || (request.auth != null && request.auth.uid == resource.data.uid);

      // Anyone can create a booking request.
      allow create: if true;

      // Only admins can modify bookings (e.g., to approve/deny).
      allow update, delete: if isAdmin();
    }
  }
}
