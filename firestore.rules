
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper functions
    function isAuth() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuth() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // User Profiles
    match /users/{userId} {
      // Admins can see all profiles
      // Users can see public profiles
      allow read: if isAdmin() || (isAuth() && resource.data.profileVisibility == 'public');
      
      // Users can see their own full profile
      allow get: if isAuth() && request.auth.uid == userId;

      // Users can create their own profile
      allow create: if isAuth() && request.auth.uid == userId;

      // Users can update their own profile, but cannot change their role
      allow update: if isAuth() && request.auth.uid == userId && !('role' in request.resource.data);
      
      // Admins can update any profile, including changing roles
      allow update: if isAdmin();
    }
    
    // Groups
    match /groups/{groupId} {
      // Anyone authenticated can view a public group's details
      allow get: if isAuth() && resource.data.type == 'public';

      // Members can get their own group details, even if private
      allow get: if isAuth() && resource.data.members[request.auth.uid] != null;
      
      // Anyone authenticated can see the list of public groups
      allow list: if isAuth() && query.get('where')[0][2] == 'public';

      // Only authenticated users can create groups
      allow create: if isAuth();

      // Only the owner or an admin of the group can update its details
      // (e.g. name, type), or an overall admin
      allow update: if isAdmin() || (isAuth() && (
        resource.data.members[request.auth.uid] == 'owner' || 
        resource.data.members[request.auth.uid] == 'admin'
      ));
      
      // Only the group owner or a platform admin can delete a group
      allow delete: if isAdmin() || (isAuth() && resource.data.members[request.auth.uid] == 'owner');
      
       // Messages within a group
       match /messages/{messageId} {
         // Members of the group can read messages
         allow read: if isAuth() && get(/databases/$(database)/documents/groups/$(groupId)).data.members[request.auth.uid] != null;
         
         // Members of the group can send messages
         allow create: if isAuth() && get(/databases/$(database)/documents/groups/$(groupId)).data.members[request.auth.uid] != null;
       }
       
       // Typing indicators within a group
       match /typing/{userId} {
         allow read, write: if isAuth() && get(/databases/$(database)/documents/groups/$(groupId)).data.members[request.auth.uid] != null;
       }
    }
    
    // Forums & Threads
    match /forums/{forumId} {
      allow read: if isAuth();
      allow create: if isAdmin(); // Only admins can create forums
      allow update, delete: if isAdmin();
    }
    
    match /threads/{threadId} {
      allow read: if isAuth();
      
      // Users can create threads. 'authorId' must be their own UID.
      allow create: if isAuth() && request.resource.data.authorId == request.auth.uid;
      
      // Author or admin can update. Protect sensitive fields.
      allow update: if isAuth() && (request.resource.data.authorId == request.auth.uid || isAdmin())
                    && !('authorId' in request.resource.data);
                    
      allow delete: if isAdmin();
      
      // Replies within a thread
      match /replies/{replyId} {
        allow read: if isAuth();
        allow create: if isAuth() && !get(/databases/$(database)/documents/threads/$(threadId)).data.isLocked;
        allow update, delete: if isAdmin();
      }
      
       match /chatMessages/{messageId} {
        allow read: if isAuth();
        allow create: if isAuth() && !get(/databases/$(database)/documents/threads/$(threadId)).data.isLocked;
        allow update, delete: if isAdmin();
      }
    }

    match /posts/{postId} {
      allow read: if isAuth() && resource.data.visibility == 'public';
      allow create: if isAuth() && request.resource.data.authorId == request.auth.uid;
      allow update: if isAuth() && resource.data.authorId == request.auth.uid;
      allow delete: if isAuth() && resource.data.authorId == request.auth.uid || isAdmin();
      
      match /likes/{userId} {
        allow read: if isAuth();
        allow write: if isAuth() && request.auth.uid == userId;
      }
      
      match /comments/{commentId} {
        allow read: if isAuth();
        allow create: if isAuth();
        allow update, delete: if isAuth() && resource.data.authorId == request.auth.uid || isAdmin();
      }
    }

    match /reports/{reportId} {
      allow read: if isAdmin();
      allow create: if isAuth();
    }
    
    match /categories/{categoryId} {
      allow read: if isAuth();
      allow create: if isAuth();
      allow update, delete: if isAdmin();
    }
    
    match /tags/{tagId} {
      allow read: if isAuth();
    }

    match /demoBookings/{bookingId} {
      allow read: if isAdmin();
      allow create: if true; // Anyone can request a demo
      allow update, delete: if isAdmin();
    }
    
    match /demoSlots/{slotId} {
      allow read: if true; // Public can see available slots
      allow write: if isAdmin(); // Only admins can create/update/delete slots
    }
  }
}
