rules_version = '2';

function isAdmin() {
  return request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
}

function isOwner(res) {
  return request.auth != null && request.auth.uid == res.data.uid;
}

service cloud.firestore {
  match /databases/{database}/documents {

    // Users collection
    match /users/{userId} {
      // Anyone can read public profiles
      allow get: if request.auth != null && (resource.data.profileVisibility == 'public' || request.auth.uid == userId || isAdmin());
      allow list: if request.auth != null;
      
      // Users can only create their own profile, admins can create any
      allow create: if request.auth.uid == userId || isAdmin();
      
      // Users can only update their own profile, admins can update any
      allow update: if request.auth.uid == userId || isAdmin();
      
      // Only admins can delete user profiles
      allow delete: if isAdmin();

      // Notifications subcollection
      match /notifications/{notificationId} {
        // Users can only read their own notifications
        allow read, list: if request.auth != null && request.auth.uid == userId;
        // Users can only update their own notifications (e.g., mark as read)
        allow update: if request.auth != null && request.auth.uid == userId;
        // Notifications are created by the backend (Cloud Functions) only
        allow create, delete: if false;
      }
    }

    // Groups collection
    match /groups/{groupId} {
        // Public groups are readable by any authenticated user
        allow get: if request.auth != null;
        allow list: if request.auth != null;
        
        // Any authenticated user can create a group
        allow create: if request.auth != null;
        
        // Only the owner or an admin can update or delete a group
        allow update, delete: if request.auth != null && (resource.data.members[request.auth.uid] == 'owner' || isAdmin());
        
        // Typing indicators
        match /typing/{userId} {
            // Any group member can write their own typing status
            allow write: if request.auth != null && get(/databases/$(database)/documents/groups/$(groupId)).data.members[request.auth.uid] != null;
            // Any group member can read typing statuses
            allow read: if request.auth != null && get(/databases/$(database)/documents/groups/$(groupId)).data.members[request.auth.uid] != null;
        }

        // Messages subcollection
        match /messages/{messageId} {
            // Any group member can read messages
            allow list, get: if request.auth != null && resource.parent.parent.data.members[request.auth.uid] != null;
            // Any group member can create messages
            allow create: if request.auth != null && resource.parent.parent.data.members[request.auth.uid] != null;
            // Only admins or message sender can delete
            allow delete: if request.auth != null && (isAdmin() || request.auth.uid == resource.data.senderId);
        }
    }
    
    // Threads and related collections
    match /threads/{threadId} {
      allow get, list: if request.auth != null;
      allow create, update: if request.auth != null;
      allow delete: if isAdmin() || (request.auth != null && request.auth.uid == resource.data.authorId);

      // Replies subcollection
      match /replies/{replyId} {
        allow get, list: if request.auth != null;
        allow create: if request.auth != null && get(/databases/$(database)/documents/threads/$(threadId)).data.isLocked == false;
        allow update: if request.auth.uid == resource.data.authorId || isAdmin();
        allow delete: if request.auth.uid == resource.data.authorId || isAdmin();
      }
      
      // ChatMessages subcollection
       match /chatMessages/{messageId} {
        allow get, list: if request.auth != null;
        allow create: if request.auth != null && get(/databases/$(database)/documents/threads/$(threadId)).data.isLocked == false;
        allow update, delete: if request.auth.uid == resource.data.senderId || isAdmin();
      }
    }
    
    // Posts and related collections (Social Feed)
    match /posts/{postId} {
        allow get, list: if request.auth != null;
        allow create, update: if request.auth.uid == request.resource.data.authorId;
        allow delete: if request.auth.uid == resource.data.authorId || isAdmin();

        match /likes/{userId} {
            allow read, create, delete: if request.auth.uid == userId;
        }

        match /comments/{commentId} {
            allow read, list, create: if request.auth != null;
            allow update, delete: if request.auth.uid == resource.data.authorId || isAdmin();
        }
    }
    
    // Demo Booking and Slots
    match /demoSlots/{slotId} {
      // Any authenticated user can read available slots
      allow get, list: if request.auth != null;
      // Only admins can create, update, or delete slots
      allow create, update, delete: if isAdmin();
    }

    match /demoBookings/{bookingId} {
      // Users can create their own booking requests
      allow create: if request.auth != null;
      
      // Users can read their own bookings, admins can read all
      allow get: if request.auth != null && (resource.data.uid == request.auth.uid || isAdmin());
      allow list: if isAdmin();

      // Only admins can update (approve/deny) or delete bookings
      allow update, delete: if isAdmin();
    }
    
    // Categories and Forums
    match /categories/{categoryId} {
        allow read, list: if request.auth != null;
        allow create, update, delete: if isAdmin();
    }
    
    match /forums/{forumId} {
        allow read, list: if request.auth != null;
        allow create, update, delete: if isAdmin();
    }

  }
}
