
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper Functions
    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function canWrite(uid) {
      let userDoc = get(/databases/$(database)/documents/users/$(uid)).data;
      return !(userDoc.isBanned ?? false) && !(userDoc.isMuted ?? false);
    }
    
    function isThreadLocked(threadId) {
      return get(/databases/$(database)/documents/threads/$(threadId)).data.isLocked ?? false;
    }

    // USER PROFILES
    match /users/{userId} {
      allow read: if request.auth != null; // Any authenticated user can read profiles
      allow create: if isOwner(userId); // Users can create their own profile
      allow update: if isOwner(userId) || isAdmin(); // Users can update their own profile, or an admin can
      allow delete: if isAdmin(); // Only admins can delete user profiles
    }

    // FORUMS & CATEGORIES
    match /forums/{forumId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && canWrite(request.auth.uid);
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    match /categories/{categoryId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && canWrite(request.auth.uid);
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // THREADS & REPLIES
    match /threads/{threadId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && canWrite(request.auth.uid);
      allow update: if request.auth != null && (
        (isOwner(resource.data.authorId) || isAdmin()) ||
        (
            // Allow any user to increment replyCount
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['replyCount', 'updatedAt', 'latestReplyAt']) &&
            request.resource.data.replyCount == resource.data.replyCount + 1
        )
      );
      allow delete: if isOwner(resource.data.authorId) || isAdmin();

      // Replies Subcollection
      match /replies/{replyId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null && canWrite(request.auth.uid) && !isThreadLocked(threadId);
        allow update: if isOwner(resource.data.authorId) || isAdmin();
        allow delete: if isOwner(resource.data.authorId) || isAdmin();
      }
    }

    // POSTS (Feed)
    match /posts/{postId} {
      allow read: if request.auth != null; // Simplified for queries
      allow create: if request.auth != null && canWrite(request.auth.uid);
      allow update: if request.auth != null && (
        (isOwner(resource.data.authorId) || isAdmin()) ||
        (
            // Allow any user to increment specific counter fields
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likesCount', 'commentsCount', 'sharesCount'])
        )
      );
      allow delete: if isOwner(resource.data.authorId) || isAdmin();

      // Likes Subcollection
      match /likes/{userId} {
        allow read: if request.auth != null;
        allow create, delete: if isOwner(userId) && canWrite(userId);
      }

      // Comments Subcollection
      match /comments/{commentId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null && canWrite(request.auth.uid);
        allow update, delete: if isOwner(resource.data.authorId) || isAdmin();
      }
    }

    // GROUPS & CHAT
    match /groups/{groupId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && canWrite(request.auth.uid);
      allow update: if request.auth != null && (
        (get(/databases/$(database)/documents/groups/$(groupId)).data.members[request.auth.uid] in ['owner', 'admin']) ||
        isAdmin() ||
        (
            // Allow joining a public group
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['members', 'memberCount']) &&
            resource.data.type == 'public'
        )
      );
      allow delete: if isAdmin();

      // Chat Messages Subcollection
      match /messages/{messageId} {
        allow read, create: if request.auth != null 
          && request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.members;
        allow update, delete: if isOwner(resource.data.senderId) || isAdmin();
      }

       // Typing indicators
      match /typing/{userId} {
        allow read, write: if isOwner(userId);
      }
    }
  }
}
