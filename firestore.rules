
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---

    function isOwner(uid) {
      return request.auth.uid == uid;
    }

    function isAdmin() {
      // Use .get() to safely access role, defaulting to 'member' if it does not exist.
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('role', 'member') == 'admin';
    }

    // Function to check if a user is authenticated and not banned or muted.
    // Handles cases where fields might be null or missing.
    function canWrite(uid) {
      let user = get(/databases/$(database)/documents/users/$(uid));
      return request.auth != null
        && user.exists()
        && user.data.get('isBanned', false) == false
        && user.data.get('isMuted', false) == false;
    }

    function isThreadLocked(threadId) {
      return get(/databases/$(database)/documents/threads/$(threadId)).data.get('isLocked', false) == true;
    }


    // --- User Profiles ---

    match /users/{userId} {
      // Any authenticated user can read a public profile. Admins can read any profile.
      allow read: if request.auth != null && (resource.data.profileVisibility == 'public' || isAdmin() || isOwner(userId));

      // Users can create their own profile.
      allow create: if isOwner(userId);

      // Users can update their own profile. Admins can update any profile.
      allow update: if request.auth != null && (isOwner(userId) || isAdmin());
    }


    // --- Forums & Categories ---

    match /forums/{forumId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && canWrite(request.auth.uid);
      allow update, delete: if isAdmin();
    }

    match /categories/{categoryId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && canWrite(request.auth.uid);
      allow update, delete: if isAdmin();
    }


    // --- Threads & Replies ---

    match /threads/{threadId} {
      allow get: if request.auth != null;
      allow list: if request.auth != null;

      allow create: if canWrite(request.auth.uid);

      // This is the critical fix.
      // It allows a user to update a thread IF:
      // 1. They are only incrementing the replyCount by 1 AND the thread is not locked.
      // OR
      // 2. They are the author or an admin (for locking, pinning, editing).
      allow update: if request.auth != null && (
        (
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['replyCount', 'updatedAt', 'latestReplyAt']) &&
          request.resource.data.replyCount == resource.data.replyCount + 1 &&
          isThreadLocked(threadId) == false
        ) || isOwner(resource.data.authorId) || isAdmin()
      );

      allow delete: if isOwner(resource.data.authorId) || isAdmin();

      // Replies subcollection
      match /replies/{replyId} {
        allow read: if request.auth != null;
        // A user can create a reply if they are authenticated, can write, and the thread is not locked.
        allow create: if canWrite(request.auth.uid) && isThreadLocked(threadId) == false;
        allow update, delete: if isOwner(resource.data.authorId) || isAdmin();
      }
    }


    // --- Groups & Chat ---

    match /groups/{groupId} {
      allow get: if request.auth != null;
      allow list: if request.auth != null; // Allow listing of public groups

      // Only authenticated users can create groups.
      allow create: if canWrite(request.auth.uid);

      // Only the group owner or an admin can update or delete a group.
      // Also allows any member to join/leave (by updating members map).
      allow update: if request.auth != null && (
        get(/databases/$(database)/documents/groups/$(groupId)).data.members[request.auth.uid] in ['owner', 'admin']
        || isAdmin()
        || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['members', 'memberCount'])
      );
      
      allow delete: if get(/databases/$(database)/documents/groups/$(groupId)).data.members[request.auth.uid] == 'owner' || isAdmin();

      // Messages subcollection
      match /messages/{messageId} {
        // Members of the group can read messages.
        allow read: if request.auth != null && request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.members;
        
        // Members of the group who are not muted can write messages.
        allow create: if request.auth != null
            && canWrite(request.auth.uid)
            && request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.members;
            
        // Only the message author can update/delete their own message (for now).
        allow update, delete: if request.auth != null && isOwner(resource.data.senderId);
      }

      // Typing indicators subcollection
      match /typing/{userId} {
        allow read, write: if request.auth != null && request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.members;
      }
    }


    // --- Posts (Feed) ---

    match /posts/{postId} {
      // Allow authenticated users to read posts. Visibility is filtered on the client.
      allow read: if request.auth != null;

      // Allow users to create posts.
      allow create: if canWrite(request.auth.uid);

      // Allow post author or admin to update/delete.
      // Also allows any user to update ONLY the likesCount, commentsCount, or sharesCount.
      allow update: if request.auth != null && (
          isOwner(resource.data.authorId)
          || isAdmin()
          || (
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likesCount', 'commentsCount', 'sharesCount'])
          )
      );

      allow delete: if isOwner(resource.data.authorId) || isAdmin();

      // Likes subcollection
      match /likes/{userId} {
        allow read: if request.auth != null;
        allow write: if isOwner(userId) && canWrite(userId);
      }

      // Comments subcollection
      match /comments/{commentId} {
        allow read: if request.auth != null;
        allow create: if canWrite(request.auth.uid);
        allow update, delete: if isOwner(resource.data.authorId) || isAdmin();
      }
    }
  }
}
